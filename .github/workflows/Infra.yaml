
name: Infra Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'Dev'
        type: choice
        options: [Dev, Qa, Nonprod, Prod]
      terraform_action:
        description: 'Terraform function to perform'
        required: false
        default: 'plan'
        type: choice
        options: [plan, apply, destroy]

jobs:
  Authentication:
    runs-on: ubuntu-latest
    permissions:
      id-token: write   # Required for OIDC
      contents: read    # Required for actions/checkout

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Resolve Account ID
        id: resolve
        run: |
          ENV="${{ github.event.inputs.environment }}"
          case "$ENV" in
            Dev)   ACCOUNT_ID="190660836704" ;;
            Qa)   ACCOUNT_ID="111111111111" ;;
            Nonprod) ACCOUNT_ID="222222222222" ;;
            Prod)  ACCOUNT_ID="333333333333" ;;
            *) echo "Invalid environment: $ENV" >&2; exit 1 ;;
          esac
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT


      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ steps.resolve.outputs.account_id }}:role/oidc-terraform
          aws-region: us-east-1

      - name: Create DynamoDB table for Terraform locks
        run: |
          aws dynamodb describe-table --table-name ${{ inputs.environment }}-tf-locks --region ap-south-1 || \
          aws dynamodb create-table \
            --table-name ${{ inputs.environment }}-tf-locks \
            --attribute-definitions AttributeName=LockID,AttributeType=S \
            --key-schema AttributeName=LockID,KeyType=HASH \
            --billing-mode PAY_PER_REQUEST \
            --region ap-south-1

      - name: Deploy
        run: |
          aws s3 ls
      
  Initilization:
    runs-on: ubuntu-latest
    needs: Authentication
    permissions:
      id-token: write
      contents: read
    environment: apply

    steps:   
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve Account ID
        id: resolve
        run: |
          ENV="${{ github.event.inputs.environment }}"
          case "$ENV" in
            Dev)   ACCOUNT_ID="190660836704" ;;
            Qa)   ACCOUNT_ID="111111111111" ;;
            Nonprod) ACCOUNT_ID="222222222222" ;;
            Prod)  ACCOUNT_ID="333333333333" ;;
            *) echo "Invalid environment: $ENV" >&2; exit 1 ;;
          esac
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ steps.resolve.outputs.account_id }}:role/oidc-terraform
          aws-region: us-east-1

      - name: Checkout terraform modules
        uses: actions/checkout@v4
        with:
          repository: muditmn/terraform-module          
          ref: main                               # tag/branch/SHA
          token: ${{ secrets.PAT }} # Fine-grained PAT or GitHub App token
          path: terraform-module


      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
      # Installs Terraform CLI; wrapper outputs can be used later
      # [7](https://github.com/marketplace/actions/hashicorp-setup-terraform)

      - name: Terraform Init
        run: terraform init -input=false
        working-directory: terraform/${{ inputs.environment }}

      - name: Terraform Validate
        run: terraform validate
        working-directory: terraform/${{ inputs.environment }}

      - name: Terraform Plan
        run: terraform plan -var-file=dev.tfvars
        working-directory: terraform/${{ inputs.environment }}
      
      - name: Terraform Apply
        run: terraform apply -auto-approve -input=false -var-file=dev.tfvars
        working-directory: terraform/${{ inputs.environment }}